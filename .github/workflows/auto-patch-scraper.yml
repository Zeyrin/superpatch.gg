name: Auto Patch Scraper

on:
  schedule:
    # Run once per day at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger
  
permissions:
  contents: write

jobs:
  scrape-patches:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
        
    - name: Run patch scraper
      run: |
        node scripts/steam-rss-scraper.js
        
    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code assets/data/patches.json || echo "changes=true" >> $GITHUB_OUTPUT
        
    - name: Create GitHub issue
      if: steps.git-check.outputs.changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸŽ® New Supervive Patch Detected - Manual Update Needed',
            body: `New patch data has been detected from the Steam RSS feed!
            
            **Action Required:** Please review and manually update the patch notes.
            
            **Workflow Run:** ${context.payload.repository.html_url}/actions/runs/${context.runId}
            **Detection Time:** ${new Date().toISOString()}
            
            Please check the latest patch data and update the site accordingly.`,
            labels: ['patch-update', 'manual-review']
          })